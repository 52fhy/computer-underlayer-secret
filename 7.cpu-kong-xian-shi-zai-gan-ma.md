# 7.CPU空闲时在干嘛？

人空闲时会发呆会无聊，计算机呢？&#x20;

假设你正在用计算机浏览网页，当网页加载完成后你开始阅读，此时你没有移动鼠标，没有敲击键盘，也没有网络通信，那么你的计算机此时在干嘛？&#x20;

有的同学可能会觉得这个问题很简单，但实际上，这个问题涉及从硬件到软件、从 CPU 到操作系统等一系列环节，理解了这个问题你就能明白操作系统是如何工作的了。

**你的计算机 CPU 使用率是多少？**

如果此时你正在计算机旁，并且安装有 Windows 或者 Linux ，你可以立刻看到自己的计算机 CPU 使 用率是多少。&#x20;

这是博主的一台安装有 Win10 的笔记本：

![](.gitbook/assets/7\_1.jpg)

可以看到大部分情况下 CPU 利用率很低，也就在 8% 左右，而且开启了 283 个进程，这么多进程基本上无所事事，都在等待某个特定事件来唤醒自己，就好比你写了一个打印用户输入的程序，如果用户一直不按键盘，那么你的进程就处于这种状态。&#x20;

有的同学可能会想也就你的比较空闲吧，实际上大部分个人计算机 CPU 使用率都差不多这样(排除掉看电影、玩游戏等场景)，如果你的使用率总是很高，风扇一直在嗡嗡的转，那么不是软件 bug 就有可能是病毒。。。&#x20;

那么有的同学可能会问，剩下的 CPU 时间都去哪里了？

### 剩下的 CPU 时间去哪里了？

这个问题也很简单，还是以 Win10 为例，打开任务管理器，找到 “详细信息” 这一栏，你会发现有一个 “系统空闲进程”，其 CPU 使用率达到了 99%，正是这个进程消耗了几乎所有的 CPU 时间。

![](.gitbook/assets/7\_2.jpg)

那么为什么存在这样一个进程呢？以及这个进程什么时候开始运行呢？&#x20;

这就要从操作系统说起了。

### 程序、进程与操作系统&#x20;

当你用最喜欢的代码编辑器编写代码时，这时的代码不过就是磁盘上的普通文件，此时的程序和操作系统没有半毛钱关系，操作系统也不认知这种文本文件。

![](.gitbook/assets/7\_3.jpg)

程序员写完代码后开始编译，这时编译器将普通的文本文件翻译成二进制可执行文件，此时的程序依然是保存在磁盘上的文件，和普通没有本质区别。

![](.gitbook/assets/7\_4.jpg)

但此时不一样的是，该文件是可执行文件，也就是说操作系统开始 “懂得” 这种文件，所谓 “懂得” 是指操作系统可以识别、解析、加载，因此必定有某种类似协议的规范，这样编译器按照这种协议生成可执行文件，操作系统就能加载了。&#x20;

在 Linux 下可执行文件格式为 ELF ，在 Windows 下是 EXE 。&#x20;

此时虽然操作系统可以识别可执行程序，**但如果你不去双击一下(或者在Linux下运行相应命令)的依然和操作系统没有半毛钱关系**。&#x20;

但是当你运行可执行程序时魔法就出现了。&#x20;

此时操作系统开始将可执行文件加载到内存，解析出代码段、数据段等，并为这个程序创建运行时需要的堆区栈区等内存区域，此时这个程序在内存中就是这样了：

![](.gitbook/assets/7\_5.jpg)

最后，根据可执行文件的内容，操作系统知道该程序应该执行的第一条机器指令是什么，并将其告诉CPU ，CPU 从该程序的第一条指令开始执行，程序就这样运行起来了。&#x20;

一个在内存中运行起来的程序显然和保存在磁盘上的二进制文件是不一样的，总的有个名字吧，根据“弄不懂原则”，这个名字就叫进程，英文名叫做Process。&#x20;

**我们把一个运行起来的程序叫做进程，这就是进程的由来。**&#x20;

此时操作系统开始掌管进程，现在进程已经有了，那么操作系统是怎么管理进程的呢？

### 调度器与进程管理

银行想必大家都去过，实际上如果你仔细观察的话银行的办事大厅就能体现出操作系统最核心的进程管理与调度。&#x20;

首先大家去银行都要排队，类似的，进程在操作系统中也是通过队列来管理的。&#x20;

同时银行还按照客户的重要程度划分了优先级，大部分都是普通客户；但当你在这家银行存上几个亿时就能升级为 VIP 客户，优先级最高，每次去银行都不用排队，优先办理你的业务。&#x20;

类似的，操作系统也会为进程划分优先级，操作系统会根据进程优先级将其放到相应的队列中供调度器调度。



